<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TV Online Directo</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: sans-serif; background: #111; color: white; text-align: center; }
        .search-box { padding: 15px; width: 80%; max-width: 500px; border-radius: 25px; border: none; margin: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: #222; padding: 10px; border-radius: 10px; cursor: pointer; border: 1px solid #333; }
        .card:hover { border-color: red; }
        .card img { width: 100%; height: 80px; object-fit: contain; }
        #player-container { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        video { width: 90%; max-width: 800px; background: #000; }
        .close { background: red; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>Buscador TV Online</h1>
    <input type="text" id="q" class="search-box" placeholder="Busca un canal (ej: NASA, DW, News)...">
    
    <div id="grid" class="grid"></div>

    <div id="player-container">
        <video id="video" controls></video>
        <button class="close" onclick="cerrar()">CERRAR REPRODUCTOR</button>
        <p id="status" style="font-size: 0.8rem; color: gray; margin-top: 10px;"></p>
    </div>

<script>
    const M3U_URL = 'https://iptv-org.github.io/iptv/languages/spa.m3u';
    let canales = [];
    const video = document.getElementById('video');
    const hls = new Hls();

    // Cargar Lista
    fetch(M3U_URL).then(r => r.text()).then(data => {
        const lines = data.split('\n');
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes('#EXTINF')) {
                const nombre = lines[i].split(',')[1];
                const logo = lines[i].match(/tvg-logo="([^"]+)"/)?.[1] || '';
                const url = lines[i+1]?.trim();
                if (url && url.startsWith('http')) canales.push({ nombre, logo, url });
            }
        }
        mostrar(canales);
    });

    function mostrar(lista) {
        document.getElementById('grid').innerHTML = lista.slice(0, 100).map(c => `
            <div class="card" onclick="ver('${c.url}', '${c.nombre}')">
                <img src="${c.logo}" onerror="this.src='https://via.placeholder.com/100x50?text=TV'">
                <p>${c.nombre}</p>
            </div>
        `).join('');
    }

    function ver(url, nombre) {
        document.getElementById('player-container').style.display = 'flex';
        document.getElementById('status').innerText = "Intentando conectar...";
        
        // --- LA SOLUCIÓN SIN INSTALAR NADA ---
        // Usamos un proxy que añade las cabeceras CORS por nosotros
        const proxy = "https://api.allorigins.win/raw?url=";
        const finalUrl = url; // Prueba directo primero, si falla, usa: proxy + encodeURIComponent(url);

        if (Hls.isSupported()) {
            hls.loadSource(finalUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play();
                document.getElementById('status').innerText = "Reproduciendo: " + nombre;
            });
            hls.on(Hls.Events.ERROR, () => {
                document.getElementById('status').innerText = "Error: Este canal bloquea la conexión externa.";
            });
        }
    }

    function cerrar() {
        video.pause();
        hls.detachMedia();
        document.getElementById('player-container').style.display = 'none';
    }

    document.getElementById('q').oninput = (e) => {
        const busqueda = e.target.value.toLowerCase();
        mostrar(canales.filter(c => c.nombre.toLowerCase().includes(busqueda)));
    };
</script>
</body>
</html>