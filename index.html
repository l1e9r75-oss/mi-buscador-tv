<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BROADCAST ‚Äî TV Online</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0c;
    --surface: #111114;
    --panel: #161619;
    --border: #2a2a30;
    --accent: #ff4500;
    --accent2: #ff8c00;
    --green: #00e676;
    --blue: #2979ff;
    --text: #e8e8ee;
    --muted: #666670;
    --mono: 'Share Tech Mono', monospace;
    --sans: 'Barlow Condensed', sans-serif;
    --body: 'Barlow', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--body);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.08) 2px, rgba(0,0,0,0.08) 4px);
    pointer-events: none;
    z-index: 9999;
  }

  /* Noise texture */
  body::after {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9998;
    opacity: 0.3;
  }

  /* HEADER */
  header {
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
    background: rgba(10,10,12,0.95);
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(12px);
  }

  .logo {
    font-family: var(--sans);
    font-weight: 900;
    font-size: 28px;
    letter-spacing: 6px;
    text-transform: uppercase;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-dot {
    width: 10px; height: 10px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 12px var(--accent), 0 0 24px rgba(255,69,0,0.4);
    animation: pulse-dot 1.5s ease-in-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.7); }
  }

  .header-info {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    display: flex; gap: 24px;
  }

  .live-badge {
    color: var(--accent);
    display: flex; align-items: center; gap: 6px;
  }

  /* MAIN LAYOUT */
  .app {
    display: grid;
    grid-template-columns: 320px 1fr;
    min-height: calc(100vh - 64px);
  }

  /* SIDEBAR */
  .sidebar {
    border-right: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-section {
    border-bottom: 1px solid var(--border);
    padding: 20px;
  }

  .section-label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 14px;
    display: flex; align-items: center; gap: 8px;
  }

  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* SEARCH */
  .search-wrap {
    position: relative;
  }

  .search-input {
    width: 100%;
    background: var(--panel);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    padding: 10px 14px 10px 40px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(255,69,0,0.15);
  }

  .search-icon {
    position: absolute;
    left: 12px; top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 14px;
    pointer-events: none;
  }

  /* CATEGORY FILTER */
  .category-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .category-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: none;
    border: none;
    color: var(--muted);
    font-family: var(--sans);
    font-size: 15px;
    font-weight: 400;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
    text-align: left;
    width: 100%;
    border-left: 2px solid transparent;
  }

  .category-btn:hover { color: var(--text); background: rgba(255,255,255,0.03); }
  .category-btn.active {
    color: var(--text);
    border-left-color: var(--accent);
    background: rgba(255,69,0,0.06);
  }

  .cat-count {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
  }

  /* M3U8 IMPORT */
  .m3u8-panel {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .m3u8-input {
    width: 100%;
    background: var(--panel);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 11px;
    padding: 10px 12px;
    outline: none;
    resize: none;
    height: 70px;
    transition: border-color 0.2s;
  }

  .m3u8-input:focus {
    border-color: var(--accent2);
    box-shadow: 0 0 0 2px rgba(255,140,0,0.12);
  }

  .m3u8-input::placeholder { color: var(--muted); }

  .btn {
    padding: 10px 16px;
    font-family: var(--sans);
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 8px; justify-content: center;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:hover {
    background: #ff6020;
    box-shadow: 0 0 16px rgba(255,69,0,0.4);
  }

  .btn-secondary {
    background: var(--panel);
    border: 1px solid var(--border);
    color: var(--text);
  }

  .btn-secondary:hover {
    border-color: var(--accent2);
    color: var(--accent2);
  }

  .btn-small {
    padding: 6px 12px;
    font-size: 11px;
  }

  .file-upload-label {
    display: block;
    padding: 10px;
    border: 1px dashed var(--border);
    color: var(--muted);
    font-family: var(--mono);
    font-size: 11px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .file-upload-label:hover {
    border-color: var(--accent2);
    color: var(--accent2);
    background: rgba(255,140,0,0.05);
  }

  input[type="file"] { display: none; }

  .imported-count {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--green);
    text-align: center;
    display: none;
  }

  /* MAIN CONTENT */
  .main {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .main-toolbar {
    padding: 16px 28px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface);
  }

  .results-info {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--muted);
  }

  .results-info span {
    color: var(--text);
  }

  .view-toggle {
    display: flex; gap: 4px;
  }

  .view-btn {
    background: none; border: 1px solid var(--border);
    color: var(--muted); padding: 6px 10px; cursor: pointer;
    font-size: 14px; transition: all 0.15s;
  }

  .view-btn.active, .view-btn:hover {
    border-color: var(--accent); color: var(--accent);
  }

  /* CHANNEL GRID */
  .channels-container {
    flex: 1;
    overflow-y: auto;
    padding: 24px 28px;
  }

  .channels-container::-webkit-scrollbar { width: 4px; }
  .channels-container::-webkit-scrollbar-track { background: var(--bg); }
  .channels-container::-webkit-scrollbar-thumb { background: var(--border); }

  .channels-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
  }

  .channels-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  /* CHANNEL CARD */
  .channel-card {
    background: var(--panel);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .channel-card::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(255,69,0,0.05), transparent);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .channel-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,69,0,0.2);
  }

  .channel-card:hover::before { opacity: 1; }

  .card-thumb {
    aspect-ratio: 16/9;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .card-thumb-bg {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 36px;
    opacity: 0.15;
  }

  .channel-logo-text {
    font-family: var(--sans);
    font-weight: 900;
    font-size: 18px;
    letter-spacing: 2px;
    color: var(--text);
    z-index: 1;
    text-transform: uppercase;
    text-align: center;
    padding: 8px;
  }

  .live-indicator {
    position: absolute;
    top: 8px; left: 8px;
    background: var(--accent);
    color: #fff;
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 2px;
    padding: 2px 6px;
    display: flex; align-items: center; gap: 4px;
  }

  .live-dot {
    width: 5px; height: 5px;
    background: #fff;
    border-radius: 50%;
    animation: pulse-dot 1s ease-in-out infinite;
  }

  .quality-badge {
    position: absolute;
    top: 8px; right: 8px;
    background: rgba(0,0,0,0.7);
    border: 1px solid var(--border);
    color: var(--accent2);
    font-family: var(--mono);
    font-size: 9px;
    padding: 2px 6px;
    letter-spacing: 1px;
  }

  .card-info {
    padding: 12px 14px;
  }

  .card-name {
    font-family: var(--sans);
    font-weight: 700;
    font-size: 15px;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .card-meta {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    display: flex; align-items: center; gap: 8px;
  }

  .card-cat {
    background: rgba(255,255,255,0.05);
    padding: 1px 6px;
    border-radius: 2px;
  }

  /* LIST VIEW */
  .channel-row {
    background: var(--panel);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 10px 16px;
    gap: 16px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .channel-row:hover {
    border-color: var(--accent);
    background: rgba(255,69,0,0.04);
  }

  .row-num {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    width: 30px;
    flex-shrink: 0;
  }

  .row-icon {
    width: 40px; height: 28px;
    background: var(--bg);
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-family: var(--sans);
    font-weight: 700;
    font-size: 10px;
    letter-spacing: 1px;
    color: var(--muted);
    flex-shrink: 0;
    text-transform: uppercase;
  }

  .row-name {
    font-family: var(--sans);
    font-weight: 600;
    font-size: 15px;
    flex: 1;
    letter-spacing: 0.5px;
  }

  .row-cat {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    width: 100px;
    flex-shrink: 0;
  }

  .row-live {
    background: var(--accent);
    color: #fff;
    font-family: var(--mono);
    font-size: 9px;
    padding: 2px 8px;
    letter-spacing: 2px;
    flex-shrink: 0;
  }

  .row-actions {
    display: flex; gap: 6px; flex-shrink: 0;
  }

  .icon-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.15s;
  }

  .icon-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* PLAYER MODAL */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .player-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    width: 90vw;
    max-width: 960px;
    box-shadow: 0 40px 80px rgba(0,0,0,0.8);
    animation: modal-in 0.25s ease;
  }

  @keyframes modal-in {
    from { opacity: 0; transform: scale(0.95) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }

  .modal-title {
    font-family: var(--sans);
    font-weight: 700;
    font-size: 18px;
    letter-spacing: 1px;
    display: flex; align-items: center; gap: 10px;
  }

  .close-btn {
    background: none; border: 1px solid var(--border);
    color: var(--muted); width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 16px; transition: all 0.15s;
  }

  .close-btn:hover { border-color: var(--accent); color: var(--accent); }

  .player-wrap {
    aspect-ratio: 16/9;
    background: #000;
    position: relative;
  }

  #player-video {
    width: 100%; height: 100%;
    display: block;
  }

  .player-status {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(0,0,0,0.7);
    font-family: var(--mono);
    font-size: 12px;
    color: var(--muted);
    gap: 10px;
  }

  .player-status .spinner {
    width: 32px; height: 32px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .modal-footer {
    padding: 14px 20px;
    border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
  }

  .channel-url-display {
    flex: 1;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 8px 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* EMPTY STATE */
  .empty-state {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 80px 20px;
    text-align: center;
    gap: 12px;
  }

  .empty-icon {
    font-size: 48px;
    opacity: 0.2;
  }

  .empty-title {
    font-family: var(--sans);
    font-weight: 700;
    font-size: 20px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
  }

  .empty-sub {
    font-size: 13px;
    color: var(--muted);
  }

  /* STATUS BAR */
  .statusbar {
    position: fixed; bottom: 0; left: 0; right: 0;
    height: 28px;
    background: var(--accent);
    display: flex; align-items: center;
    padding: 0 20px;
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 1px;
    color: #fff;
    gap: 24px;
    z-index: 200;
  }

  .status-item { display: flex; align-items: center; gap: 6px; opacity: 0.85; }
  .status-item.highlight { opacity: 1; font-weight: 600; }

  /* TOAST */
  .toast {
    position: fixed; bottom: 40px; right: 24px;
    background: var(--panel);
    border: 1px solid var(--accent);
    border-left: 3px solid var(--accent);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    padding: 12px 18px;
    z-index: 2000;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    transform: translateX(120%);
    transition: transform 0.3s ease;
  }

  .toast.show { transform: translateX(0); }

  @media (max-width: 768px) {
    .app { grid-template-columns: 1fr; }
    .sidebar { display: none; }
    .sidebar.mobile-open { display: flex; position: fixed; inset: 0; z-index: 500; width: 300px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-dot"></div>
    BROADCAST
  </div>
  <div class="header-info">
    <span class="live-badge"><span class="live-dot"></span> EN VIVO</span>
    <span id="clock">--:--:--</span>
    <span id="channel-count-hdr">0 CANALES</span>
  </div>
</header>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="section-label">Buscar canal</div>
      <div class="search-wrap">
        <span class="search-icon">‚åï</span>
        <input type="text" class="search-input" id="search-input" placeholder="nombre, categor√≠a, pa√≠s...">
      </div>
    </div>

    <div class="sidebar-section">
      <div class="section-label">Categor√≠as</div>
      <ul class="category-list" id="category-list">
        <li><button class="category-btn active" data-cat="all" onclick="filterCat('all', this)">Todos <span class="cat-count" id="cnt-all">0</span></button></li>
        <li><button class="category-btn" data-cat="noticias" onclick="filterCat('noticias', this)">Noticias <span class="cat-count" id="cnt-noticias">0</span></button></li>
        <li><button class="category-btn" data-cat="deportes" onclick="filterCat('deportes', this)">Deportes <span class="cat-count" id="cnt-deportes">0</span></button></li>
        <li><button class="category-btn" data-cat="entretenimiento" onclick="filterCat('entretenimiento', this)">Entretenimiento <span class="cat-count" id="cnt-entretenimiento">0</span></button></li>
        <li><button class="category-btn" data-cat="peliculas" onclick="filterCat('peliculas', this)">Pel√≠culas <span class="cat-count" id="cnt-peliculas">0</span></button></li>
        <li><button class="category-btn" data-cat="musica" onclick="filterCat('musica', this)">M√∫sica <span class="cat-count" id="cnt-musica">0</span></button></li>
        <li><button class="category-btn" data-cat="infantil" onclick="filterCat('infantil', this)">Infantil <span class="cat-count" id="cnt-infantil">0</span></button></li>
        <li><button class="category-btn" data-cat="importado" onclick="filterCat('importado', this)">M3U8 Importados <span class="cat-count" id="cnt-importado">0</span></button></li>
      </ul>
    </div>

    <div class="m3u8-panel">
      <div class="section-label">Importar lista M3U8</div>

      <!-- URL -->
      <textarea class="m3u8-input" id="m3u8-url" placeholder="Pegar URL de lista M3U8&#10;https://ejemplo.com/lista.m3u8"></textarea>
      <button class="btn btn-primary btn-small" onclick="loadM3U8fromURL()">‚¨á CARGAR URL</button>

      <!-- Separador -->
      <div style="text-align:center; font-family: var(--mono); font-size:10px; color:var(--muted);">‚Äî o subir archivo ‚Äî</div>

      <!-- Archivo -->
      <label class="file-upload-label" for="m3u8-file">
        üìÇ Seleccionar archivo .m3u / .m3u8
      </label>
      <input type="file" id="m3u8-file" accept=".m3u,.m3u8,.txt" onchange="loadM3U8fromFile(event)">

      <!-- Pegar contenido directo -->
      <textarea class="m3u8-input" id="m3u8-content" placeholder="O pegar contenido M3U8 directo aqu√≠...&#10;#EXTM3U&#10;#EXTINF:-1,Canal Ejemplo&#10;http://url-stream.m3u8" style="height:90px;"></textarea>
      <button class="btn btn-secondary btn-small" onclick="parseM3U8(document.getElementById('m3u8-content').value, 'manual')">‚ö° PARSEAR CONTENIDO</button>

      <div class="imported-count" id="imported-count">‚úì <span id="imported-num">0</span> canales importados</div>

      <button class="btn btn-secondary btn-small" onclick="clearImported()" style="margin-top:auto;">üóë Limpiar importados</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="main-toolbar">
      <div class="results-info" id="results-info">Mostrando <span>0</span> canales</div>
      <div class="view-toggle">
        <button class="view-btn active" id="grid-btn" onclick="setView('grid')" title="Cuadr√≠cula">‚äû</button>
        <button class="view-btn" id="list-btn" onclick="setView('list')" title="Lista">‚â°</button>
      </div>
    </div>

    <div class="channels-container" id="channels-container">
      <div id="channels-render"></div>
    </div>
  </main>
</div>

<!-- PLAYER MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closePlayer(event)">
  <div class="player-modal">
    <div class="modal-header">
      <div class="modal-title">
        <span class="live-dot" style="width:8px;height:8px;background:var(--accent);border-radius:50%;animation:pulse-dot 1s infinite;"></span>
        <span id="modal-channel-name">‚Äî</span>
      </div>
      <button class="close-btn" onclick="closePlayerDirect()">‚úï</button>
    </div>
    <div class="player-wrap">
      <video id="player-video" controls autoplay playsinline></video>
      <div class="player-status" id="player-status">
        <div class="spinner"></div>
        <span>Cargando se√±al...</span>
      </div>
    </div>
    <div class="modal-footer">
      <div class="channel-url-display" id="modal-url">‚Äî</div>
      <button class="btn btn-secondary btn-small" onclick="copyURL()">üìã COPIAR URL</button>
      <button class="btn btn-secondary btn-small" onclick="openExternal()">‚Üó ABRIR VLC</button>
    </div>
  </div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <span class="status-item highlight">‚¨§ BROADCAST TV</span>
  <span class="status-item">CANALES: <span id="sb-count">0</span></span>
  <span class="status-item">M3U8: <span id="sb-m3u8">0</span> IMPORTADOS</span>
  <span class="status-item" id="sb-status">LISTO</span>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.10/hls.min.js"></script>
<script>
// =====================
// DEFAULT CHANNELS
// =====================
const defaultChannels = [
  // Noticias
  { id:1, name:'CNN en Espa√±ol', cat:'noticias', country:'üá∫üá∏', quality:'HD', url:'https://cnnespanol.cnn.com/', icon:'CNN', live:true },
  { id:2, name:'DW Espa√±ol', cat:'noticias', country:'üá©üá™', quality:'HD', url:'https://www.dw.com/es/en-vivo/s-100825', icon:'DW', live:true },
  { id:3, name:'NHK World', cat:'noticias', country:'üáØüáµ', quality:'FHD', url:'https://www3.nhk.or.jp/nhkworld/en/live/', icon:'NHK', live:true },
  { id:4, name:'France 24', cat:'noticias', country:'üá´üá∑', quality:'HD', url:'https://www.france24.com/es/en-directo', icon:'F24', live:true },
  { id:5, name:'Euronews', cat:'noticias', country:'üá™üá∫', quality:'HD', url:'https://es.euronews.com/en-directo', icon:'EUR', live:true },

  // Deportes
  { id:6, name:'ESPN 3 AR', cat:'deportes', country:'üá¶üá∑', quality:'HD', url:'https://www.espn.com.ar/espnplay/', icon:'ESPN', live:true },
  { id:7, name:'TyC Sports', cat:'deportes', country:'üá¶üá∑', quality:'HD', url:'https://www.tycsports.com/tv-en-vivo/', icon:'TYC', live:true },
  { id:8, name:'DirectTV Sports', cat:'deportes', country:'üá¶üá∑', quality:'FHD', url:'https://www.directvsports.com/', icon:'DSP', live:true },
  { id:9, name:'Canal de la Ciudad', cat:'deportes', country:'üá¶üá∑', quality:'SD', url:'https://www.canaldelaciudad.gob.ar/en-vivo/', icon:'CDC', live:true },

  // Entretenimiento
  { id:10, name:'Telefe', cat:'entretenimiento', country:'üá¶üá∑', quality:'HD', url:'https://mitelefe.com/', icon:'TLF', live:true },
  { id:11, name:'El Trece', cat:'entretenimiento', country:'üá¶üá∑', quality:'HD', url:'https://www.eltrecetv.com.ar/', icon:'EL3', live:true },
  { id:12, name:'Am√©rica TV', cat:'entretenimiento', country:'üá¶üá∑', quality:'HD', url:'https://www.americatv.com.ar/', icon:'AMR', live:true },
  { id:13, name:'Canal 9', cat:'entretenimiento', country:'üá¶üá∑', quality:'SD', url:'https://www.canal9.com.ar/', icon:'CN9', live:true },
  { id:14, name:'NET TV', cat:'entretenimiento', country:'üá¶üá∑', quality:'HD', url:'https://www.nettv.com.ar/', icon:'NET', live:true },

  // Pel√≠culas
  { id:15, name:'Cine.ar Play', cat:'peliculas', country:'üá¶üá∑', quality:'HD', url:'https://play.cine.ar/', icon:'CIN', live:false },
  { id:16, name:'Pluto TV', cat:'peliculas', country:'üåç', quality:'HD', url:'https://pluto.tv/', icon:'PLT', live:true },

  // M√∫sica
  { id:17, name:'Vorterix Rock', cat:'musica', country:'üá¶üá∑', quality:'HD', url:'https://www.vorterix.com/', icon:'VTX', live:true },
  { id:18, name:'VH1 Classic', cat:'musica', country:'üá∫üá∏', quality:'HD', url:'https://www.vh1.com/', icon:'VH1', live:true },

  // Infantil
  { id:19, name:'Cartoon Network LA', cat:'infantil', country:'üá∫üá∏', quality:'HD', url:'https://www.cartoonnetwork.com/', icon:'CN', live:true },
  { id:20, name:'Discovery Kids', cat:'infantil', country:'üá∫üá∏', quality:'HD', url:'https://www.discoverykids.com/', icon:'DKS', live:true },
];

// =====================
// STATE
// =====================
let allChannels = [...defaultChannels];
let importedChannels = [];
let currentCat = 'all';
let currentView = 'grid';
let searchTerm = '';
let currentChannel = null;
let hlsInstance = null;

// =====================
// INIT
// =====================
function init() {
  updateCounts();
  renderChannels();
  startClock();
}

function startClock() {
  const tick = () => {
    document.getElementById('clock').textContent = new Date().toLocaleTimeString('es-AR');
  };
  tick(); setInterval(tick, 1000);
}

// =====================
// FILTER & RENDER
// =====================
function getFiltered() {
  let channels = [...allChannels, ...importedChannels];
  if (currentCat !== 'all') channels = channels.filter(c => c.cat === currentCat);
  if (searchTerm) {
    const s = searchTerm.toLowerCase();
    channels = channels.filter(c =>
      c.name.toLowerCase().includes(s) ||
      c.cat.toLowerCase().includes(s) ||
      (c.country && c.country.includes(s))
    );
  }
  return channels;
}

function updateCounts() {
  const all = [...allChannels, ...importedChannels];
  document.getElementById('cnt-all').textContent = all.length;
  const cats = ['noticias','deportes','entretenimiento','peliculas','musica','infantil'];
  cats.forEach(cat => {
    const el = document.getElementById('cnt-' + cat);
    if (el) el.textContent = all.filter(c => c.cat === cat).length;
  });
  document.getElementById('cnt-importado').textContent = importedChannels.length;
  document.getElementById('channel-count-hdr').textContent = all.length + ' CANALES';
  document.getElementById('sb-count').textContent = all.length;
  document.getElementById('sb-m3u8').textContent = importedChannels.length;
}

function renderChannels() {
  const filtered = getFiltered();
  const container = document.getElementById('channels-render');
  const info = document.getElementById('results-info');
  info.innerHTML = `Mostrando <span>${filtered.length}</span> canales`;

  if (filtered.length === 0) {
    container.innerHTML = `<div class="empty-state">
      <div class="empty-icon">üì°</div>
      <div class="empty-title">Sin se√±al</div>
      <div class="empty-sub">No se encontraron canales con esos criterios</div>
    </div>`;
    return;
  }

  if (currentView === 'grid') {
    container.className = 'channels-grid';
    container.innerHTML = filtered.map(c => cardHTML(c)).join('');
  } else {
    container.className = 'channels-list';
    container.innerHTML = filtered.map((c, i) => rowHTML(c, i+1)).join('');
  }
}

const ICONS = {'noticias':'üì∞','deportes':'‚öΩ','entretenimiento':'üé≠','peliculas':'üé¨','musica':'üéµ','infantil':'üß∏','importado':'üìã'};

function cardHTML(c) {
  const col = catColor(c.cat);
  return `<div class="channel-card" onclick="openPlayer(${allChannels.concat(importedChannels).indexOf(c)})">
    <div class="card-thumb">
      <div class="card-thumb-bg">${ICONS[c.cat] || 'üì∫'}</div>
      <div class="channel-logo-text" style="color:${col}">${c.icon || c.name.substring(0,4)}</div>
      ${c.live ? '<div class="live-indicator"><span class="live-dot"></span> EN VIVO</div>' : ''}
      <div class="quality-badge">${c.quality || 'HD'}</div>
    </div>
    <div class="card-info">
      <div class="card-name">${c.name}</div>
      <div class="card-meta">
        ${c.country ? `<span>${c.country}</span>` : ''}
        <span class="card-cat">${c.cat}</span>
      </div>
    </div>
  </div>`;
}

function rowHTML(c, i) {
  const idx = allChannels.concat(importedChannels).indexOf(c);
  return `<div class="channel-row">
    <span class="row-num">${String(i).padStart(3,'0')}</span>
    <div class="row-icon" style="color:${catColor(c.cat)}">${c.icon || c.name.substring(0,4)}</div>
    <span class="row-name">${c.name}</span>
    <span class="row-cat">${c.cat}</span>
    ${c.live ? '<span class="row-live">EN VIVO</span>' : '<span style="width:60px"></span>'}
    <div class="row-actions">
      <button class="icon-btn" onclick="openPlayer(${idx})" title="Reproducir">‚ñ∂</button>
      <button class="icon-btn" onclick="openExternal2('${c.url}')" title="Abrir en VLC">‚Üó</button>
    </div>
  </div>`;
}

function catColor(cat) {
  const map = {noticias:'#2979ff',deportes:'#00e676',entretenimiento:'#ff4500',peliculas:'#aa00ff',musica:'#ff8c00',infantil:'#ff4081',importado:'#00bcd4'};
  return map[cat] || '#888';
}

// =====================
// PLAYER
// =====================
function openPlayer(idx) {
  const c = [...allChannels, ...importedChannels][idx];
  if (!c) return;
  currentChannel = c;

  document.getElementById('modal-channel-name').textContent = c.name;
  document.getElementById('modal-url').textContent = c.url || '‚Äî';
  document.getElementById('player-status').style.display = 'flex';

  const video = document.getElementById('player-video');

  // Destroy previous HLS instance
  if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
  video.src = '';

  const url = c.url || '';

  if (url.includes('.m3u8') || url.includes('stream')) {
    if (Hls.isSupported()) {
      hlsInstance = new Hls({ enableWorker: true });
      hlsInstance.loadSource(url);
      hlsInstance.attachMedia(video);
      hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
        video.play().catch(() => {});
        document.getElementById('player-status').style.display = 'none';
      });
      hlsInstance.on(Hls.Events.ERROR, (e, data) => {
        if (data.fatal) showPlayerError(url);
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = url;
      video.addEventListener('loadedmetadata', () => {
        video.play();
        document.getElementById('player-status').style.display = 'none';
      });
    } else {
      showPlayerError(url);
    }
  } else {
    // Web URL ‚Äî show info only
    showPlayerError(url, true);
  }

  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('sb-status').textContent = 'REPRODUCIENDO: ' + c.name;
}

function showPlayerError(url, isWeb) {
  const status = document.getElementById('player-status');
  status.innerHTML = `<div style="font-size:32px;opacity:.4">${isWeb ? 'üåê' : '‚ö†Ô∏è'}</div>
    <span style="color:var(--muted)">${isWeb ? 'Canal web ‚Äî abre en navegador o VLC' : 'No se pudo reproducir directamente'}</span>
    <button class="btn btn-primary btn-small" onclick="openExternal2('${url}')" style="margin-top:8px">‚Üó ABRIR EN NAVEGADOR</button>`;
}

function closePlayerDirect() {
  document.getElementById('modal-overlay').classList.remove('open');
  const video = document.getElementById('player-video');
  video.pause(); video.src = '';
  if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
  document.getElementById('sb-status').textContent = 'LISTO';
}

function closePlayer(e) {
  if (e.target === document.getElementById('modal-overlay')) closePlayerDirect();
}

function copyURL() {
  const url = currentChannel?.url || '';
  navigator.clipboard.writeText(url).then(() => showToast('URL copiada al portapapeles'));
}

function openExternal() {
  if (currentChannel?.url) openExternal2(currentChannel.url);
}

function openExternal2(url) {
  window.open(url, '_blank');
}

// =====================
// M3U8 IMPORT
// =====================
function loadM3U8fromURL() {
  const url = document.getElementById('m3u8-url').value.trim();
  if (!url) { showToast('‚ö† Ingresa una URL v√°lida'); return; }

  document.getElementById('sb-status').textContent = 'CARGANDO M3U8...';
  showToast('Intentando cargar lista...');

  // Try CORS proxy
  const proxyURL = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
  fetch(proxyURL)
    .then(r => r.json())
    .then(data => {
      if (data.contents) {
        parseM3U8(data.contents, 'url');
      } else {
        showToast('‚ö† No se pudo obtener contenido');
      }
    })
    .catch(() => {
      showToast('‚ö† Error CORS. Prueba subir el archivo directamente.');
      document.getElementById('sb-status').textContent = 'ERROR CORS';
    });
}

function loadM3U8fromFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => parseM3U8(e.target.result, 'file');
  reader.readAsText(file);
}

function parseM3U8(content, source) {
  if (!content || !content.trim()) { showToast('‚ö† Contenido vac√≠o'); return; }

  const lines = content.split('\n').map(l => l.trim()).filter(l => l);
  const channels = [];
  let current = null;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    if (line.startsWith('#EXTINF')) {
      current = {};

      // Parse name
      const nameMatch = line.match(/,(.+)$/);
      current.name = nameMatch ? nameMatch[1].trim() : 'Canal ' + (channels.length + 1);

      // Parse attributes
      const groupMatch = line.match(/group-title="([^"]+)"/i);
      if (groupMatch) current.cat = normalizeCat(groupMatch[1]);
      else current.cat = 'importado';

      const logoMatch = line.match(/tvg-logo="([^"]+)"/i);
      if (logoMatch) current.logo = logoMatch[1];

      const countryMatch = line.match(/tvg-country="([^"]+)"/i);
      if (countryMatch) current.country = countryMatch[1];

      current.icon = current.name.replace(/[^a-zA-Z0-9]/g,'').substring(0,4).toUpperCase();
      current.quality = line.includes('1080') ? 'FHD' : line.includes('720') ? 'HD' : 'SD';
      current.live = true;

    } else if (line.startsWith('http') || line.startsWith('rtmp') || line.startsWith('rtsp')) {
      if (current) {
        current.url = line;
        current.id = Date.now() + Math.random();
        channels.push(current);
        current = null;
      }
    }
  }

  if (channels.length === 0) {
    showToast('‚ö† No se encontraron canales en la lista');
    return;
  }

  // Add to importedChannels (deduplicate by URL)
  const existingURLs = importedChannels.map(c => c.url);
  const newOnes = channels.filter(c => !existingURLs.includes(c.url));
  importedChannels.push(...newOnes);

  updateCounts();
  renderChannels();

  const countEl = document.getElementById('imported-count');
  countEl.style.display = 'block';
  document.getElementById('imported-num').textContent = importedChannels.length;

  showToast(`‚úì ${newOnes.length} canales importados (${importedChannels.length} total)`);
  document.getElementById('sb-status').textContent = `${importedChannels.length} M3U8 CARGADOS`;

  // Auto-switch to importado category
  if (source !== 'manual' || importedChannels.length > 0) {
    filterCat('importado', document.querySelector('[data-cat="importado"]'));
  }
}

function normalizeCat(g) {
  g = g.toLowerCase();
  if (g.includes('notic') || g.includes('news') || g.includes('info')) return 'noticias';
  if (g.includes('deport') || g.includes('sport') || g.includes('f√∫tbol') || g.includes('futbol')) return 'deportes';
  if (g.includes('pel') || g.includes('movie') || g.includes('cine') || g.includes('film')) return 'peliculas';
  if (g.includes('musi') || g.includes('music')) return 'musica';
  if (g.includes('infant') || g.includes('kids') || g.includes('ni√±os') || g.includes('cartoon')) return 'infantil';
  if (g.includes('entret') || g.includes('general') || g.includes('variedad')) return 'entretenimiento';
  return 'importado';
}

function clearImported() {
  importedChannels = [];
  updateCounts();
  renderChannels();
  document.getElementById('imported-count').style.display = 'none';
  document.getElementById('m3u8-url').value = '';
  document.getElementById('m3u8-content').value = '';
  showToast('Canales importados eliminados');
}

// =====================
// CONTROLS
// =====================
function filterCat(cat, btn) {
  currentCat = cat;
  document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderChannels();
}

function setView(view) {
  currentView = view;
  document.getElementById('grid-btn').classList.toggle('active', view === 'grid');
  document.getElementById('list-btn').classList.toggle('active', view === 'list');
  renderChannels();
}

document.getElementById('search-input').addEventListener('input', e => {
  searchTerm = e.target.value;
  renderChannels();
});

// =====================
// TOAST
// =====================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// =====================
// START
// =====================
init();
</script>
</body>
</html>
